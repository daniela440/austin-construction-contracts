<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Construction Contracts Dashboard</title>
<style>
  :root {
    --blue-900: #1a2744;
    --blue-700: #1e3a5f;
    --blue-500: #2563eb;
    --blue-400: #60a5fa;
    --blue-100: #dbeafe;
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --gray-600: #475569;
    --gray-800: #1e293b;
    --orange-500: #f97316;
    --orange-100: #ffedd5;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--gray-50); color: var(--gray-800); }
  header { background: var(--blue-900); color: #fff; padding: 1.5rem; text-align: center; }
  header h1 { font-size: 1.6rem; margin-bottom: .2rem; }
  header p { color: var(--blue-400); font-size: .9rem; }
  .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

  /* Tabs */
  .tabs { background: var(--blue-700); display: flex; gap: 0; }
  .tab-btn {
    padding: .75rem 2rem; border: none; background: transparent; color: rgba(255,255,255,.65);
    font-size: .9rem; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent;
    transition: color .15s, border-color .15s; white-space: nowrap;
  }
  .tab-btn:hover { color: #fff; }
  .tab-btn.active { color: #fff; border-bottom-color: var(--blue-400); }

  /* Loading */
  .loading { text-align: center; padding: 3rem; color: var(--gray-600); }
  .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid var(--blue-500); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error { text-align: center; padding: 2rem; color: #dc2626; background: #fef2f2; border-radius: .5rem; }

  /* Filters */
  .filters { background: #fff; border-radius: .5rem; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); margin-bottom: 1rem; }
  .filters h2 { font-size: .95rem; color: var(--gray-600); margin-bottom: .75rem; text-transform: uppercase; letter-spacing: .04em; }
  .filter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: .75rem; align-items: end; }
  .filter-group label { display: block; font-size: .75rem; font-weight: 600; color: var(--gray-600); margin-bottom: .25rem; text-transform: uppercase; letter-spacing: .03em; }
  .filter-group input, .filter-group select {
    width: 100%; padding: .45rem .6rem; border: 1px solid var(--gray-200); border-radius: .375rem;
    font-size: .85rem; background: #fff; color: var(--gray-800);
  }
  .filter-group input:focus, .filter-group select:focus { outline: none; border-color: var(--blue-500); box-shadow: 0 0 0 2px rgba(37,99,235,.15); }
  .btn-clear {
    padding: .45rem 1rem; border: 1px solid var(--gray-300); border-radius: .375rem; background: #fff;
    font-size: .85rem; color: var(--gray-600); cursor: pointer; white-space: nowrap; align-self: end;
  }
  .btn-clear:hover { background: var(--gray-100); border-color: var(--gray-400); }
  .btn-export {
    padding: .45rem 1rem; border: none; border-radius: .375rem; background: var(--blue-500);
    font-size: .85rem; color: #fff; cursor: pointer; white-space: nowrap;
  }
  .btn-export:hover { background: var(--blue-700); }

  /* Results bar */
  .results-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem; font-size: .85rem; color: var(--gray-600); flex-wrap: wrap; gap: .5rem; }
  .results-bar strong { color: var(--blue-900); }

  /* Table */
  .table-wrap { overflow-x: auto; background: #fff; border-radius: .5rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
  table { width: 100%; border-collapse: collapse; font-size: .8rem; }
  th { background: var(--blue-900); color: #fff; padding: .6rem .5rem; text-align: left; cursor: pointer; white-space: nowrap; user-select: none; }
  th:hover { background: var(--blue-700); }
  th.sorted-asc::after { content: ' \u25B2'; font-size: .6rem; }
  th.sorted-desc::after { content: ' \u25BC'; font-size: .6rem; }
  td { padding: .55rem .5rem; border-bottom: 1px solid var(--gray-100); max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  td.expandable { cursor: pointer; position: relative; }
  td.expandable:hover { background: var(--blue-100); }
  td.expandable::after { content: '...'; color: var(--gray-400); font-size: .7rem; }
  td.expanded { white-space: normal; overflow: visible; max-width: 400px; word-wrap: break-word; background: #fffde7; }
  td.expanded::after { content: ''; }
  tr:hover td { background: var(--blue-100); }
  td.expanded, tr:hover td.expanded { background: #fffde7; }
  td a { color: var(--blue-500); text-decoration: none; }
  td a:hover { text-decoration: underline; }
  .no-results { text-align: center; padding: 2rem; color: var(--gray-400); font-size: .9rem; }

  /* OSHA priority badge */
  .badge { display: inline-block; padding: .15rem .45rem; border-radius: .25rem; font-size: .7rem; font-weight: 700; }
  .badge-high { background: #fee2e2; color: #991b1b; }
  .badge-medium { background: #fef3c7; color: #92400e; }
  .badge-low { background: #dcfce7; color: #166534; }

  footer { text-align: center; padding: 1.5rem; font-size: .8rem; color: var(--gray-400); }

  @media (max-width: 700px) {
    .filter-grid { grid-template-columns: 1fr 1fr; }
    .tab-btn { padding: .75rem 1.25rem; font-size: .8rem; }
  }
  @media (max-width: 450px) {
    .filter-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<header>
  <h1>Construction Contracts Dashboard</h1>
  <p>Multi-State Government Construction Contract Awards &amp; OSHA Leads</p>
</header>

<div class="tabs">
  <button class="tab-btn active" id="tabContracts" onclick="switchTab('contracts')">Procurement Contracts</button>
  <button class="tab-btn" id="tabOsha" onclick="switchTab('osha')">OSHA Leads 2026</button>
</div>

<div class="container">

  <!-- ===== CONTRACTS TAB ===== -->
  <div id="panelContracts">
    <div id="contractsLoading" class="loading">Loading contract data from Google Sheets...</div>
    <div id="contractsError" class="error" style="display:none;"></div>
    <div id="contractsContent" style="display:none;">
      <div class="filters">
        <h2>Filter Contracts</h2>
        <div class="filter-grid">
          <div class="filter-group">
            <label>State/City</label>
            <select id="fState"><option value="">All States</option></select>
          </div>
          <div class="filter-group">
            <label>Company Name</label>
            <input type="text" id="fCompany" placeholder="Search company...">
          </div>
          <div class="filter-group">
            <label>Begin Date From</label>
            <input type="date" id="fDateFrom">
          </div>
          <div class="filter-group">
            <label>Min Amount ($)</label>
            <input type="number" id="fAmountMin" placeholder="0" min="0">
          </div>
          <div class="filter-group">
            <label>Max Amount ($)</label>
            <input type="number" id="fAmountMax" placeholder="Any" min="0">
          </div>
          <div class="filter-group">
            <label>Commodity Type</label>
            <select id="fType"><option value="">All Types</option></select>
          </div>
          <div class="filter-group">
            <button class="btn-clear" id="btnClear">Clear Filters</button>
          </div>
        </div>
      </div>
      <div class="results-bar">
        <span>Showing <strong id="resultCount">0</strong> of <strong id="totalCount">0</strong> contracts</span>
        <span>Total filtered value: <strong id="filteredValue">$0</strong> &nbsp; <button class="btn-export" id="btnExport">Export CSV</button></span>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr id="tableHead"></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== OSHA TAB ===== -->
  <div id="panelOsha" style="display:none;">
    <div id="oshaLoading" class="loading">Loading OSHA inspection data...</div>
    <div id="oshaError" class="error" style="display:none;"></div>
    <div id="oshaContent" style="display:none;">
      <div class="filters">
        <h2>Filter OSHA Leads</h2>
        <div class="filter-grid">
          <div class="filter-group">
            <label>State</label>
            <select id="ofState"><option value="">All States</option></select>
          </div>
          <div class="filter-group">
            <label>Company Name</label>
            <input type="text" id="ofCompany" placeholder="Search company...">
          </div>
          <div class="filter-group">
            <label>Industry</label>
            <select id="ofIndustry"><option value="">All Industries</option></select>
          </div>
          <div class="filter-group">
            <label>Inspection Type</label>
            <select id="ofInspType"><option value="">All Types</option></select>
          </div>
          <div class="filter-group">
            <button class="btn-clear" id="oBtnClear">Clear Filters</button>
          </div>
        </div>
      </div>
      <div class="results-bar">
        <span>Showing <strong id="oResultCount">0</strong> of <strong id="oTotalCount">0</strong> companies</span>
        <span><button class="btn-export" id="oBtnExport">Export CSV</button></span>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr id="oTableHead"></tr></thead>
          <tbody id="oTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>
<footer>Data source: Government Procurement Portals &amp; OSHA IMIS &bull; Auto-updated from Google Sheets</footer>

<script>
const SHEET_ID = '1HQMnHzPrx0Qa4ijuaR0BcVptpiiVG7mE3Po17rvruKQ';
const CONTRACTS_SHEET = 'Webscraper Tool for Procurement Sites Two';
const OSHA_SHEET = 'OSHA company audits';
const csvUrl = s => `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(s)}`;

let CONTRACTS_DATA = [];
let OSHA_DATA = [];
let contractsLoaded = false;
let oshaLoaded = false;

// ── Tab switching ──────────────────────────────────────────────
function switchTab(tab) {
  document.getElementById('panelContracts').style.display = tab === 'contracts' ? '' : 'none';
  document.getElementById('panelOsha').style.display      = tab === 'osha'      ? '' : 'none';
  document.getElementById('tabContracts').classList.toggle('active', tab === 'contracts');
  document.getElementById('tabOsha').classList.toggle('active', tab === 'osha');
  if (tab === 'osha' && !oshaLoaded) loadOsha();
}

// ── CSV parser ─────────────────────────────────────────────────
function parseAllCSV(csv) {
  const rows = [];
  let cur = '', inQ = false, row = [];
  for (let i = 0; i < csv.length; i++) {
    const c = csv[i];
    if (c === '"') {
      if (inQ && csv[i+1] === '"') { cur += '"'; i++; } else inQ = !inQ;
    } else if (c === ',' && !inQ) {
      row.push(cur); cur = '';
    } else if ((c === '\n' || c === '\r') && !inQ) {
      row.push(cur); cur = '';
      if (row.length > 0) rows.push(row);
      row = [];
      if (c === '\r' && csv[i+1] === '\n') i++;
    } else cur += c;
  }
  if (cur || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

const fmtWebsite = v => {
  if (!v) return '';
  try {
    const u = v.startsWith('http') ? v : 'https://' + v;
    return '<a href="' + u + '" target="_blank">' + new URL(u).hostname.replace(/^www\./, '') + '</a>';
  } catch(e) { return v; }
};

// ── CONTRACTS ─────────────────────────────────────────────────
const COLS = [
  {key:'state',    label:'State/City'},
  {key:'company',  label:'Company'},
  {key:'website',  label:'Website', fmt: fmtWebsite},
  {key:'companyInfo', label:'Company Info', expand:true},
  {key:'contact',  label:'Contact'},
  {key:'title',    label:'Title'},
  {key:'phone',    label:'Phone'},
  {key:'email',    label:'Email'},
  {key:'amount',   label:'Award Amount', fmt:v=>v?'$'+Number(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):''},
  {key:'date',     label:'Begin Date'},
  {key:'type',     label:'Commodity Type'},
  {key:'description', label:'Description', expand:true},
  {key:'link',     label:'Link', fmt:v=>v?'<a href="'+v+'" target="_blank">View</a>':''}
];

const fmt$ = v => '$' + Number(v||0).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0});

async function loadContracts() {
  try {
    const csv = await fetch(csvUrl(CONTRACTS_SHEET)).then(r => { if(!r.ok) throw new Error('Fetch failed'); return r.text(); });
    const rows = parseAllCSV(csv);
    if (rows.length < 2) throw new Error('No data');
    CONTRACTS_DATA = rows.slice(1).map(row => ({
      state: (row[0]||'').trim(), company: (row[1]||'').trim(),
      contact: (row[2]||'').trim(), phone: (row[3]||'').trim(),
      email: (row[4]||'').trim(), address: (row[5]||'').trim(),
      website: (row[6]||'').trim(), contract: (row[7]||'').trim(),
      amount: parseFloat((row[8]||'0').replace(/[$,]/g,''))||0,
      date: (row[10]||'').trim(), link: (row[11]||'').trim(),
      description: (row[12]||'').trim(), type: (row[13]||'').trim(),
      companyInfo: (row[14]||'').trim(), title: (row[15]||'').trim()
    })).filter(d => d.company);
    contractsLoaded = true;
    document.getElementById('contractsLoading').style.display = 'none';
    document.getElementById('contractsContent').style.display = '';
    initContractsUI();
  } catch(err) {
    document.getElementById('contractsLoading').style.display = 'none';
    document.getElementById('contractsError').style.display = '';
    document.getElementById('contractsError').textContent = 'Error loading contracts: ' + err.message;
  }
}

function initContractsUI() {
  const fState = document.getElementById('fState');
  const fType  = document.getElementById('fType');
  [...new Set(CONTRACTS_DATA.map(d=>d.state))].filter(Boolean).sort().forEach(s=>{
    const o=document.createElement('option'); o.value=s; o.textContent=s; fState.appendChild(o);
  });
  [...new Set(CONTRACTS_DATA.map(d=>d.type))].filter(Boolean).sort().forEach(t=>{
    const o=document.createElement('option'); o.value=t; o.textContent=t; fType.appendChild(o);
  });
  document.getElementById('totalCount').textContent = CONTRACTS_DATA.length;
  const thead = document.getElementById('tableHead');
  COLS.forEach(c=>{
    const th=document.createElement('th'); th.textContent=c.label; th.dataset.key=c.key;
    th.onclick=()=>{ if(cSortKey===c.key){cSortAsc=!cSortAsc;}else{cSortKey=c.key;cSortAsc=true;} thead.querySelectorAll('th').forEach(t=>t.classList.remove('sorted-asc','sorted-desc')); th.classList.add(cSortAsc?'sorted-asc':'sorted-desc'); renderContracts(); };
    thead.appendChild(th);
  });
  ['fCompany','fDateFrom','fAmountMin','fAmountMax'].forEach(id=>document.getElementById(id).addEventListener('input',renderContracts));
  fState.addEventListener('change',renderContracts);
  fType.addEventListener('change',renderContracts);
  document.getElementById('btnClear').addEventListener('click',()=>{
    ['fCompany','fDateFrom','fAmountMin','fAmountMax'].forEach(id=>document.getElementById(id).value='');
    fState.value=''; fType.value=''; renderContracts();
  });
  document.getElementById('btnExport').addEventListener('click',exportContracts);
  renderContracts();
}

let cSortKey='amount', cSortAsc=false;

function getFilteredContracts(){
  const stateQ=document.getElementById('fState').value, compQ=document.getElementById('fCompany').value.toLowerCase(),
        dateFrom=document.getElementById('fDateFrom').value, amtMin=document.getElementById('fAmountMin').value,
        amtMax=document.getElementById('fAmountMax').value, type=document.getElementById('fType').value;
  return CONTRACTS_DATA.filter(d=>{
    if(stateQ && d.state!==stateQ) return false;
    if(compQ && !d.company.toLowerCase().includes(compQ)) return false;
    if(dateFrom && d.date<dateFrom) return false;
    if(amtMin && d.amount<Number(amtMin)) return false;
    if(amtMax && d.amount>Number(amtMax)) return false;
    if(type && d.type!==type) return false;
    return true;
  });
}

function renderContracts(){
  let rows=getFilteredContracts();
  document.getElementById('resultCount').textContent=rows.length;
  document.getElementById('filteredValue').textContent=fmt$(rows.reduce((s,d)=>s+d.amount,0));
  rows.sort((a,b)=>{let va=a[cSortKey],vb=b[cSortKey]; return typeof va==='number'?(cSortAsc?va-vb:vb-va):(cSortAsc?String(va||'').localeCompare(String(vb||'')):String(vb||'').localeCompare(String(va||'')));});
  const tbody=document.getElementById('tableBody');
  if(!rows.length){tbody.innerHTML='<tr><td colspan="'+COLS.length+'" class="no-results">No contracts match the current filters.</td></tr>';return;}
  tbody.innerHTML=rows.map(d=>'<tr>'+COLS.map(c=>{const v=d[c.key],display=c.fmt?c.fmt(v):(v||''),isLong=c.expand&&typeof v==='string'&&v.length>30,cls=isLong?' class="expandable"':'';return '<td'+cls+' title="'+(typeof v==='string'?v.replace(/"/g,'&quot;'):(v||''))+'">'+display+'</td>';}).join('')+'</tr>').join('');
  tbody.querySelectorAll('td.expandable').forEach(td=>td.addEventListener('click',function(e){if(e.target.tagName==='A')return;this.classList.toggle('expanded');this.classList.toggle('expandable');}));
}

function exportContracts(){
  const rows=getFilteredContracts(); if(!rows.length){alert('No data to export');return;}
  const exportCols=[{key:'state',label:'State/City'},{key:'company',label:'Company'},{key:'website',label:'Website'},{key:'companyInfo',label:'Company Info'},{key:'contact',label:'Contact'},{key:'title',label:'Title'},{key:'phone',label:'Phone'},{key:'email',label:'Email'},{key:'amount',label:'Award Amount'},{key:'date',label:'Begin Date'},{key:'type',label:'Commodity Type'},{key:'description',label:'Description'},{key:'link',label:'Link'}];
  const esc=v=>{if(v==null)return '';const s=String(v);return(s.includes(',')||s.includes('"')||s.includes('\n'))?'"'+s.replace(/"/g,'""')+'"':s;};
  let csv=exportCols.map(c=>esc(c.label)).join(',')+'\n';
  rows.forEach(d=>{csv+=exportCols.map(c=>esc(d[c.key])).join(',')+'\n';});
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download='contracts_'+new Date().toISOString().slice(0,10)+'.csv'; a.click();
}

// ── OSHA ──────────────────────────────────────────────────────
const OSHA_COLS = [
  {key:'company',   label:'Company'},
  {key:'city',      label:'City'},
  {key:'state',     label:'State'},
  {key:'address',   label:'Address'},
  {key:'naicsCode', label:'NAICS Code'},
  {key:'industry',  label:'Industry'},
  {key:'inspDate',  label:'Inspection Date'},
  {key:'inspType',  label:'Inspection Type'},
  {key:'oshaLink',  label:'OSHA Link', fmt:v=>v?'<a href="'+v+'" target="_blank">View</a>':''},
  {key:'website',   label:'Website', fmt: fmtWebsite},
  {key:'contactName',label:'Contact Name'},
  {key:'title',     label:'Title'},
  {key:'email',     label:'Email'},
  {key:'phone',     label:'Phone'},
  {key:'companyInfo',label:'Company Info', expand:true}
];

async function loadOsha() {
  try {
    const csv = await fetch(csvUrl(OSHA_SHEET)).then(r => { if(!r.ok) throw new Error('Fetch failed'); return r.text(); });
    const rows = parseAllCSV(csv);

    // Parse all data rows, filter to 2026 only by inspection date
    OSHA_DATA = [];
    for (let i = 0; i < rows.length; i++) {
      const r = rows[i];
      const cell0 = (r[0]||'').trim();
      if (!cell0 || cell0 === 'Company' || cell0.startsWith('===') || cell0.startsWith('These')) continue;
      const inspDate = (r[6]||'').trim();
      if (!inspDate.includes('2026')) continue;  // 2026 only
      OSHA_DATA.push({
        company:     cell0,
        city:        (r[1]||'').trim(),
        state:       (r[2]||'').trim(),
        address:     (r[3]||'').trim(),
        naicsCode:   (r[4]||'').trim(),
        industry:    (r[5]||'').trim(),
        inspDate:    (r[6]||'').trim(),
        inspType:    (r[7]||'').trim(),
        // r[8]=Scope r[9]=Violations r[10]=Serious r[11]=Willful r[12]=Repeat r[13]=InitPenalty r[14]=CurPenalty r[15]=Priority
        oshaLink:    (r[16]||'').trim(),
        website:     (r[17]||'').trim(),
        contactName: (r[18]||'').trim(),
        title:       (r[19]||'').trim(),
        email:       (r[20]||'').trim(),
        phone:       (r[21]||'').trim(),
        companyInfo: (r[22]||'').trim()
      });
    }

    oshaLoaded = true;
    document.getElementById('oshaLoading').style.display = 'none';
    document.getElementById('oshaContent').style.display = '';
    initOshaUI();
  } catch(err) {
    document.getElementById('oshaLoading').style.display = 'none';
    document.getElementById('oshaError').style.display = '';
    document.getElementById('oshaError').textContent = 'Error loading OSHA data: ' + err.message;
  }
}

function initOshaUI() {
  const ofState   = document.getElementById('ofState');
  const ofIndustry= document.getElementById('ofIndustry');
  const ofInspType= document.getElementById('ofInspType');

  [...new Set(OSHA_DATA.map(d=>d.state))].filter(Boolean).sort().forEach(s=>{
    const o=document.createElement('option'); o.value=s; o.textContent=s; ofState.appendChild(o);
  });
  [...new Set(OSHA_DATA.map(d=>d.industry))].filter(Boolean).sort().forEach(s=>{
    const o=document.createElement('option'); o.value=s; o.textContent=s; ofIndustry.appendChild(o);
  });
  [...new Set(OSHA_DATA.map(d=>d.inspType))].filter(Boolean).sort().forEach(s=>{
    const o=document.createElement('option'); o.value=s; o.textContent=s; ofInspType.appendChild(o);
  });

  document.getElementById('oTotalCount').textContent = OSHA_DATA.length;

  const thead = document.getElementById('oTableHead');
  OSHA_COLS.forEach(c=>{
    const th=document.createElement('th'); th.textContent=c.label; th.dataset.key=c.key;
    th.onclick=()=>{ if(oSortKey===c.key){oSortAsc=!oSortAsc;}else{oSortKey=c.key;oSortAsc=true;} thead.querySelectorAll('th').forEach(t=>t.classList.remove('sorted-asc','sorted-desc')); th.classList.add(oSortAsc?'sorted-asc':'sorted-desc'); renderOsha(); };
    thead.appendChild(th);
  });

  document.getElementById('ofCompany').addEventListener('input', renderOsha);
  ofState.addEventListener('change', renderOsha);
  ofIndustry.addEventListener('change', renderOsha);
  ofInspType.addEventListener('change', renderOsha);
  document.getElementById('oBtnClear').addEventListener('click', ()=>{
    document.getElementById('ofCompany').value='';
    ofState.value=''; ofIndustry.value=''; ofInspType.value='';
    renderOsha();
  });
  document.getElementById('oBtnExport').addEventListener('click', exportOsha);
  renderOsha();
}

let oSortKey='inspDate', oSortAsc=false;

function getFilteredOsha(){
  const stateQ=document.getElementById('ofState').value, compQ=document.getElementById('ofCompany').value.toLowerCase(),
        industryQ=document.getElementById('ofIndustry').value, inspTypeQ=document.getElementById('ofInspType').value;
  return OSHA_DATA.filter(d=>{
    if(stateQ && d.state!==stateQ) return false;
    if(compQ && !d.company.toLowerCase().includes(compQ)) return false;
    if(industryQ && d.industry!==industryQ) return false;
    if(inspTypeQ && d.inspType!==inspTypeQ) return false;
    return true;
  });
}

function renderOsha(){
  let rows=getFilteredOsha();
  document.getElementById('oResultCount').textContent=rows.length;
  rows.sort((a,b)=>{let va=a[oSortKey],vb=b[oSortKey];return typeof va==='number'?(oSortAsc?va-vb:vb-va):(oSortAsc?String(va||'').localeCompare(String(vb||'')):String(vb||'').localeCompare(String(va||'')));});
  const tbody=document.getElementById('oTableBody');
  if(!rows.length){tbody.innerHTML='<tr><td colspan="'+OSHA_COLS.length+'" class="no-results">No results match the current filters.</td></tr>';return;}
  tbody.innerHTML=rows.map(d=>'<tr>'+OSHA_COLS.map(c=>{const v=d[c.key],display=c.fmt?c.fmt(v):(v||''),isLong=c.expand&&typeof v==='string'&&v.length>30,cls=isLong?' class="expandable"':'';return '<td'+cls+' title="'+(typeof v==='string'?v.replace(/"/g,'&quot;'):(v||''))+'">'+display+'</td>';}).join('')+'</tr>').join('');
  tbody.querySelectorAll('td.expandable').forEach(td=>td.addEventListener('click',function(e){if(e.target.tagName==='A')return;this.classList.toggle('expanded');this.classList.toggle('expandable');}));
}

function exportOsha(){
  const rows=getFilteredOsha(); if(!rows.length){alert('No data to export');return;}
  const exportCols=OSHA_COLS.map(c=>({key:c.key,label:c.label}));
  const esc=v=>{if(v==null)return '';const s=String(v);return(s.includes(',')||s.includes('"')||s.includes('\n'))?'"'+s.replace(/"/g,'""')+'"':s;};
  let csv=exportCols.map(c=>esc(c.label)).join(',')+'\n';
  rows.forEach(d=>{csv+=exportCols.map(c=>esc(d[c.key])).join(',')+'\n';});
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download='osha_leads_'+new Date().toISOString().slice(0,10)+'.csv'; a.click();
}

// Load contracts on start, OSHA loads on first tab click
loadContracts();
</script>
</body>
</html>
