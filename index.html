<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Construction Contracts Dashboard</title>
<style>
  :root {
    --blue-900: #1a2744;
    --blue-700: #1e3a5f;
    --blue-500: #2563eb;
    --blue-400: #60a5fa;
    --blue-100: #dbeafe;
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --gray-600: #475569;
    --gray-800: #1e293b;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--gray-50); color: var(--gray-800); }
  header { background: var(--blue-900); color: #fff; padding: 1.5rem; text-align: center; }
  header h1 { font-size: 1.6rem; margin-bottom: .2rem; }
  header p { color: var(--blue-400); font-size: .9rem; }
  .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

  /* Loading */
  .loading { text-align: center; padding: 3rem; color: var(--gray-600); }
  .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid var(--blue-500); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error { text-align: center; padding: 2rem; color: #dc2626; background: #fef2f2; border-radius: .5rem; }

  /* Filters */
  .filters { background: #fff; border-radius: .5rem; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); margin-bottom: 1rem; }
  .filters h2 { font-size: .95rem; color: var(--gray-600); margin-bottom: .75rem; text-transform: uppercase; letter-spacing: .04em; }
  .filter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: .75rem; align-items: end; }
  .filter-group label { display: block; font-size: .75rem; font-weight: 600; color: var(--gray-600); margin-bottom: .25rem; text-transform: uppercase; letter-spacing: .03em; }
  .filter-group input, .filter-group select {
    width: 100%; padding: .45rem .6rem; border: 1px solid var(--gray-200); border-radius: .375rem;
    font-size: .85rem; background: #fff; color: var(--gray-800);
  }
  .filter-group input:focus, .filter-group select:focus { outline: none; border-color: var(--blue-500); box-shadow: 0 0 0 2px rgba(37,99,235,.15); }
  .btn-clear {
    padding: .45rem 1rem; border: 1px solid var(--gray-300); border-radius: .375rem; background: #fff;
    font-size: .85rem; color: var(--gray-600); cursor: pointer; white-space: nowrap; align-self: end;
  }
  .btn-clear:hover { background: var(--gray-100); border-color: var(--gray-400); }

  /* Results bar */
  .results-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem; font-size: .85rem; color: var(--gray-600); flex-wrap: wrap; gap: .5rem; }
  .results-bar strong { color: var(--blue-900); }

  /* Table */
  .table-wrap { overflow-x: auto; background: #fff; border-radius: .5rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
  table { width: 100%; border-collapse: collapse; font-size: .8rem; }
  th { background: var(--blue-900); color: #fff; padding: .6rem .5rem; text-align: left; cursor: pointer; white-space: nowrap; user-select: none; }
  th:hover { background: var(--blue-700); }
  th.sorted-asc::after { content: ' \u25B2'; font-size: .6rem; }
  th.sorted-desc::after { content: ' \u25BC'; font-size: .6rem; }
  td { padding: .55rem .5rem; border-bottom: 1px solid var(--gray-100); max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  tr:hover td { background: var(--blue-100); }
  td a { color: var(--blue-500); text-decoration: none; }
  td a:hover { text-decoration: underline; }
  .no-results { text-align: center; padding: 2rem; color: var(--gray-400); font-size: .9rem; }

  footer { text-align: center; padding: 1.5rem; font-size: .8rem; color: var(--gray-400); }

  @media (max-width: 700px) {
    .filter-grid { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 450px) {
    .filter-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<header>
  <h1>Construction Contracts Dashboard</h1>
  <p>Multi-State Government Construction Contract Awards</p>
</header>
<div class="container">
  <div id="loadingMsg" class="loading">Loading contract data from Google Sheets...</div>
  <div id="errorMsg" class="error" style="display:none;"></div>

  <div id="mainContent" style="display:none;">
    <!-- Filters -->
    <div class="filters">
      <h2>Filter Contracts</h2>
      <div class="filter-grid">
        <div class="filter-group">
          <label>State/City</label>
          <select id="fState"><option value="">All States</option></select>
        </div>
        <div class="filter-group">
          <label>Company Name</label>
          <input type="text" id="fCompany" placeholder="Search company...">
        </div>
        <div class="filter-group">
          <label>Begin Date From</label>
          <input type="date" id="fDateFrom">
        </div>
        <div class="filter-group">
          <label>Min Amount ($)</label>
          <input type="number" id="fAmountMin" placeholder="0" min="0">
        </div>
        <div class="filter-group">
          <label>Max Amount ($)</label>
          <input type="number" id="fAmountMax" placeholder="Any" min="0">
        </div>
        <div class="filter-group">
          <label>Commodity Type</label>
          <select id="fType"><option value="">All Types</option></select>
        </div>
        <div class="filter-group">
          <button class="btn-clear" id="btnClear">Clear Filters</button>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="results-bar">
      <span>Showing <strong id="resultCount">0</strong> of <strong id="totalCount">0</strong> contracts</span>
      <span>Total filtered value: <strong id="filteredValue">$0</strong></span>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr id="tableHead"></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</div>
<footer>Data source: Government Procurement Portals &bull; Auto-updated from Google Sheets</footer>

<script>
// Google Sheets CSV URL
const SHEET_ID = '1HQMnHzPrx0Qa4ijuaR0BcVptpiiVG7mE3Po17rvruKQ';
const SHEET_NAME = 'Webscraper Tool for Procurement Sites Two';
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

let DATA = [];

const COLS = [
  {key:"state",label:"State/City"},
  {key:"company",label:"Company"},
  {key:"contract",label:"Contract Name"},
  {key:"amount",label:"Award Amount",fmt:v=>v?'$'+Number(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):''},
  {key:"date",label:"Begin Date"},
  {key:"type",label:"Commodity Type"},
  {key:"contact",label:"Contact"},
  {key:"phone",label:"Phone"},
  {key:"email",label:"Email"},
  {key:"description",label:"Description"},
  {key:"link",label:"Link",fmt:v=>v?'<a href="'+v+'" target="_blank">View</a>':''}
];

const fmt$ = v => '$' + Number(v||0).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0});

// Parse CSV
function parseCSV(csv) {
  const lines = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < csv.length; i++) {
    const char = csv[i];
    if (char === '"') {
      if (inQuotes && csv[i+1] === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      lines.push(current);
      current = '';
    } else if ((char === '\n' || char === '\r') && !inQuotes) {
      if (current || lines.length > 0) {
        lines.push(current);
        current = '';
      }
      if (lines.length > 0) {
        return { row: lines, rest: csv.slice(i + (csv[i+1] === '\n' ? 2 : 1)) };
      }
    } else {
      current += char;
    }
  }
  if (current || lines.length > 0) {
    lines.push(current);
  }
  return { row: lines, rest: '' };
}

function parseAllCSV(csv) {
  const rows = [];
  let remaining = csv.trim();
  while (remaining) {
    const { row, rest } = parseCSV(remaining);
    if (row.length > 0) rows.push(row);
    if (rest === remaining) break;
    remaining = rest;
  }
  return rows;
}

// Fetch and parse data
async function loadData() {
  try {
    const response = await fetch(CSV_URL);
    if (!response.ok) throw new Error('Failed to fetch data');
    const csv = await response.text();
    const rows = parseAllCSV(csv);

    if (rows.length < 2) throw new Error('No data found in sheet');

    // Skip header row, parse data
    // Columns: City, Company Name, Contact Name, Phone, Email, Address, Website, Contract Name, Award Amount, Amount Expended, Begin Date, Award Link, Project Description, Commodity Type
    DATA = rows.slice(1).map(row => ({
      state: (row[0] || '').trim(),
      company: (row[1] || '').trim(),
      contact: (row[2] || '').trim(),
      phone: (row[3] || '').trim(),
      email: (row[4] || '').trim(),
      address: (row[5] || '').trim(),
      website: (row[6] || '').trim(),
      contract: (row[7] || '').trim(),
      amount: parseFloat((row[8] || '0').replace(/[$,]/g, '')) || 0,
      amountExpended: parseFloat((row[9] || '0').replace(/[$,]/g, '')) || 0,
      date: (row[10] || '').trim(),
      link: (row[11] || '').trim(),
      description: (row[12] || '').trim(),
      type: (row[13] || '').trim()
    })).filter(d => d.company); // Filter out empty rows

    document.getElementById('loadingMsg').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    initUI();
  } catch (err) {
    document.getElementById('loadingMsg').style.display = 'none';
    document.getElementById('errorMsg').style.display = 'block';
    document.getElementById('errorMsg').textContent = 'Error loading data: ' + err.message + '. Make sure the Google Sheet is shared publicly.';
  }
}

function initUI() {
  const fState = document.getElementById('fState');
  const fType = document.getElementById('fType');

  // Populate dropdowns
  [...new Set(DATA.map(d=>d.state))].filter(Boolean).sort().forEach(s=>{
    const o=document.createElement('option'); o.value=s; o.textContent=s; fState.appendChild(o);
  });
  [...new Set(DATA.map(d=>d.type))].filter(Boolean).sort().forEach(t=>{
    const o=document.createElement('option'); o.value=t; o.textContent=t; fType.appendChild(o);
  });

  document.getElementById('totalCount').textContent = DATA.length;

  // Table header
  const thead = document.getElementById('tableHead');
  COLS.forEach(c=>{
    const th = document.createElement('th');
    th.textContent = c.label;
    th.dataset.key = c.key;
    if(c.key === sortKey) th.classList.add('sorted-desc');
    th.onclick = () => {
      if(sortKey === c.key){ sortAsc = !sortAsc; } else { sortKey = c.key; sortAsc = true; }
      thead.querySelectorAll('th').forEach(t=>t.classList.remove('sorted-asc','sorted-desc'));
      th.classList.add(sortAsc ? 'sorted-asc' : 'sorted-desc');
      renderTable();
    };
    thead.appendChild(th);
  });

  // Bind filter events
  ['fCompany','fDateFrom','fAmountMin','fAmountMax'].forEach(id=>{
    document.getElementById(id).addEventListener('input', renderTable);
  });
  fState.addEventListener('change', renderTable);
  fType.addEventListener('change', renderTable);

  document.getElementById('btnClear').addEventListener('click', ()=>{
    document.getElementById('fCompany').value = '';
    document.getElementById('fDateFrom').value = '';
    document.getElementById('fAmountMin').value = '';
    document.getElementById('fAmountMax').value = '';
    fState.value = '';
    fType.value = '';
    renderTable();
  });

  renderTable();
}

let sortKey = 'amount', sortAsc = false;
const tbody = document.getElementById('tableBody');

function getFiltered(){
  const stateQ = document.getElementById('fState').value;
  const compQ = document.getElementById('fCompany').value.toLowerCase();
  const dateFrom = document.getElementById('fDateFrom').value;
  const amtMin = document.getElementById('fAmountMin').value;
  const amtMax = document.getElementById('fAmountMax').value;
  const type = document.getElementById('fType').value;

  return DATA.filter(d => {
    if(stateQ && d.state !== stateQ) return false;
    if(compQ && !d.company.toLowerCase().includes(compQ)) return false;
    if(dateFrom && d.date < dateFrom) return false;
    if(amtMin && d.amount < Number(amtMin)) return false;
    if(amtMax && d.amount > Number(amtMax)) return false;
    if(type && d.type !== type) return false;
    return true;
  });
}

function renderTable(){
  let rows = getFiltered();
  document.getElementById('resultCount').textContent = rows.length;
  document.getElementById('filteredValue').textContent = fmt$(rows.reduce((s,d)=>s+d.amount,0));

  rows.sort((a,b)=>{
    let va=a[sortKey], vb=b[sortKey];
    if(typeof va==='number') return sortAsc? va-vb : vb-va;
    return sortAsc? String(va||'').localeCompare(String(vb||'')) : String(vb||'').localeCompare(String(va||''));
  });

  if(rows.length === 0){
    tbody.innerHTML = '<tr><td colspan="'+COLS.length+'" class="no-results">No contracts match the current filters.</td></tr>';
    return;
  }
  tbody.innerHTML = rows.map(d=>
    '<tr>'+COLS.map(c=>{
      const v = d[c.key];
      const display = c.fmt ? c.fmt(v) : (v || '');
      return '<td title="'+(typeof v==='string'?v.replace(/"/g,'&quot;'):(v||''))+'">'+display+'</td>';
    }).join('')+'</tr>'
  ).join('');
}

// Load data on page load
loadData();
</script>
</body>
</html>
